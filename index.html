<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة دردشة ومكالمات متكاملة</title>
    <!-- مكتبات PeerJS و Pusher -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #121212; color: #fff; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { display: flex; width: 95vw; height: 95vh; gap: 15px; }
        .video-container { flex: 3; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; background-color: #1e1e1e; border-radius: 10px; padding: 10px; }
        .video-wrapper { position: relative; border-radius: 8px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .video-wrapper .name-tag { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; }
        .chat-container { flex: 1; display: flex; flex-direction: column; background-color: #1e1e1e; border-radius: 10px; overflow: hidden; }
        .chat-header { background-color: #333; padding: 15px; text-align: center; font-weight: bold; }
        .chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; }
        .message { margin-bottom: 10px; }
        .message .user { font-weight: bold; color: #bb86fc; }
        .chat-form { display: flex; padding: 10px; }
        #messageInput { flex-grow: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; border-radius: 5px; }
        #sendButton { background: #bb86fc; color: #121212; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 5px; cursor: pointer; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container">
        <div class="video-container" id="video-grid">
            <!-- فيديوهات المستخدمين ستظهر هنا -->
        </div>
        <div class="chat-container">
            <div class="chat-header">الدردشة النصية</div>
            <div class="chat-messages" id="messages"></div>
            <form class="chat-form" id="chatForm">
                <input type="text" id="messageInput" placeholder="اكتب رسالتك..." autocomplete="off" required>
                <button type="submit" id="sendButton">إرسال</button>
            </form>
        </div>
    </div>

    <script>
        // --- الإعدادات الأولية ---
        const videoGrid = document.getElementById('video-grid');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messages');

        const myPeerId = prompt("أدخل رقمك (1 أو 2):", Math.floor(Math.random() * 1000));
        const myName = `المستخدم ${myPeerId}`;

        // --- تهيئة الفيديو الخاص بي ---
        const myVideo = document.createElement('video');
        myVideo.muted = true; // كتم صوتي لنفسي
        addVideoStream(myVideo, null, myName); // عرض الفيديو الخاص بي أولاً

        let myStream;
        navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        }).then(stream => {
            myStream = stream;
            addVideoStream(myVideo, stream, myName);
        }).catch(err => {
            console.error("Failed to get local stream", err);
            alert("لا يمكن الوصول للكاميرا. الرجاء السماح بالوصول.");
        });

        // --- تهيئة PeerJS ---
        const peer = new Peer(myPeerId, {
            // لا نحتاج لخادم PeerJS خارجي الآن لأننا سنستخدم Pusher للإشارة
            // ولكن في تطبيق إنتاجي، يفضل وجود خادم TURN/STUN
        });

        // --- تهيئة Pusher (الجزء الأهم) ---
        // نستخدم "قنوات الحضور" (Presence Channels) لمعرفة من هو متصل
        const pusher = new Pusher('89d6f63e5c3177e7359c', {
            cluster: 'eu',
            authEndpoint: 'http://fi11.bot-hosting.net:20856/pusher/auth' // مسار التوثيق في الباك اند
        });

        const channel = pusher.subscribe('presence-video-chat');

        // --- ربط PeerJS مع Pusher ---
        // عندما يكتمل اشتراكي في القناة
        channel.bind('pusher:subscription_succeeded', (members) => {
            // عندما أدخل، أتصل بكل الأعضاء الموجودين قبلي
            members.each(member => {
                if (member.id !== pusher.connection.socket_id) {
                    callUser(member.info.peerId);
                }
            });
        });

        // عندما ينضم عضو جديد
        channel.bind('pusher:member_added', (member) => {
            // العضو الجديد هو من سيتصل بي، لذا أنا سأنتظر مكالمته
        });
        
        // عندما يخرج عضو
        channel.bind('pusher:member_removed', (member) => {
            // إزالة فيديو العضو الذي خرج
            const videoToRemove = document.getElementById(member.info.peerId);
            if (videoToRemove) videoToRemove.remove();
        });

        // عندما أتلقى مكالمة من شخص آخر
        peer.on('call', call => {
            call.answer(myStream); // أرد على المكالمة ببث الفيديو الخاص بي
            const video = document.createElement('video');
            call.on('stream', userVideoStream => {
                addVideoStream(video, userVideoStream, call.peer); // عرض فيديو المتصل
            });
        });

        function callUser(peerIdToCall) {
            const call = peer.call(peerIdToCall, myStream);
            const video = document.createElement('video');
            call.on('stream', userVideoStream => {
                addVideoStream(video, userVideoStream, peerIdToCall);
            });
        }
        
        // --- قسم الدردشة النصية ---
        channel.bind('chat-message', (data) => {
            appendChatMessage(data.user, data.message);
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            // إرسال الرسالة إلى الخادم ليقوم بتوزيعها
            fetch('http://fi11.bot-hosting.net:20856/api/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: myName, message: message })
            });
            messageInput.value = '';
        });

        // --- دوال مساعدة ---
        function addVideoStream(video, stream, name) {
            if(stream) video.srcObject = stream;
            video.addEventListener('loadedmetadata', () => {
                video.play();
            });
            const wrapper = document.createElement('div');
            wrapper.classList.add('video-wrapper');
            wrapper.id = name;
            const nameTag = document.createElement('div');
            nameTag.classList.add('name-tag');
            nameTag.innerText = name;
            wrapper.append(video, nameTag);
            videoGrid.append(wrapper);
        }

        function appendChatMessage(user, message) {
            const msgElement = document.createElement('div');
            msgElement.classList.add('message');
            msgElement.innerHTML = `<span class="user">${user}:</span> ${message}`;
            messagesContainer.append(msgElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // عندما يصبح peer جاهزًا، نقوم بتحديث معلوماتنا في القناة
        peer.on('open', id => {
            channel.members.me.info.peerId = id;
        });

    </script>
</body>
</html>
